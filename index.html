<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tendermint RPC Monitoring</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
</head>

<body>
    <section class="section">
        <div class="container">
            <h1 class="title is-2">
                Tendermint RPC Monitoring
            </h1>
            <p class="subtitle is-4">
                Chain: <span id="network">-</span> (<span id="synced">not synced</span>)
            </p>
        </div>
    </section>
    <section class="section">
        <div class="container">
            <div class="columns is-multiline">
                <div class="column is-6-tablet is-3-fullhd">
                    <div class="box">
                        <h2 class="title is-3">Chain height</h2>
                        <p class="is-size-1" id="height"></p>
                    </div>
                </div>
                <div class="column is-6-tablet is-3-fullhd">
                    <div class="box">
                        <h2 class="title is-3">Active validators</h2>
                        <p class="is-size-1" id="validators"></p>
                    </div>
                </div>
                <div class="column is-6-tablet is-3-fullhd">
                    <div class="box">
                        <h2 class="title is-3">TXs in last block</h2>
                        <p class="is-size-1" id="txs"></p>
                    </div>
                </div>
                <div class="column is-6-tablet is-3-fullhd">
                    <div class="box">
                        <h2 class="title is-3">Mempool TXs</h2>
                        <p class="is-size-1" id="mempool"></p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <script type="module">
        const rpc = 'http://65.21.204.124:29657';

        async function load_network() {
            let status = await fetch(`${rpc}/status?`);
            status = await status.json();
            status = status.result;

            const height = status.sync_info.latest_block_height;
            document.getElementById("height").innerText = new Intl.NumberFormat('en-US').format(height);

            const chain = status.node_info.network;
            document.getElementById("network").innerText = chain;

            const is_synced = !status.sync_info.catching_up;
            document.getElementById("synced").innerText = is_synced ? 'synced' : 'not synced';

            let validators = await fetch(`${rpc}/validators?height=${height}&page=1&per_page=5`);
            validators = await validators.json();
            validators = validators.result;

            const validators_count = validators.total;
            document.getElementById("validators").innerText = new Intl.NumberFormat('en-US').format(validators_count);

            let block = await fetch(`${rpc}/blockchain?minHeight=${height}&maxHeight=${height}`);
            block = await block.json();
            block = block.result;

            const txs_count = block.block_metas[0].num_txs;
            document.getElementById("txs").innerText = new Intl.NumberFormat('en-US').format(txs_count);
        }
        async function load_mempool() {
            let mempool = await fetch(`${rpc}/num_unconfirmed_txs?`);
            mempool = await mempool.json();
            mempool = mempool.result;

            const mempool_count = mempool.n_txs;
            document.getElementById("mempool").innerText = new Intl.NumberFormat('en-US').format(mempool_count);
        }
        load_network();
        load_mempool();
        let networkTimerId = setInterval(load_network, 5000);
        let mempoolTimerId = setInterval(load_mempool, 500);
        window.onunload = function () {
            clearInterval(networkTimerId);
            clearInterval(mempoolTimerId);
        }
    </script>
</body>

</html>